{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Mounith%20Varma%20Akkala/OneDrive/Desktop/New%20folder%20%282%29/v0-smart-pharmacy-ui/app/api/forecasting/price-surge/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { createClient } from '@supabase/supabase-js'\r\n\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n)\r\n\r\nexport async function GET() {\r\n  try {\r\n    // Get historical sales and price data\r\n    const { data: salesData, error: salesError } = await supabase\r\n      .from('sales')\r\n      .select(`\r\n        *,\r\n        medicines (name, current_price)\r\n      `)\r\n      .gte('created_at', new Date(Date.now() - 180 * 24 * 60 * 60 * 1000).toISOString()) // Last 6 months\r\n\r\n    if (salesError) throw salesError\r\n\r\n    // Get current inventory levels\r\n    const { data: inventoryData, error: inventoryError } = await supabase\r\n      .from('inventory')\r\n      .select('medicine_id, quantity')\r\n\r\n    if (inventoryError) throw inventoryError\r\n\r\n    // Process data to generate forecasts\r\n    const medicineMap = new Map()\r\n    \r\n    salesData?.forEach(sale => {\r\n      const medicineId = sale.medicine_id\r\n      const medicineName = sale.medicines?.name\r\n      const price = sale.medicines?.current_price || sale.unit_price\r\n      const date = new Date(sale.created_at).toISOString().split('T')[0]\r\n\r\n      if (!medicineMap.has(medicineId)) {\r\n        medicineMap.set(medicineId, {\r\n          id: medicineId,\r\n          name: medicineName,\r\n          current_price: price,\r\n          sales_history: [],\r\n          price_history: []\r\n        })\r\n      }\r\n\r\n      const medicine = medicineMap.get(medicineId)\r\n      medicine.sales_history.push({\r\n        date,\r\n        quantity: sale.quantity,\r\n        price: sale.unit_price\r\n      })\r\n    })\r\n\r\n    const forecasts = Array.from(medicineMap.values()).map(medicine => {\r\n      // Simple price surge prediction algorithm\r\n      const recentPrices = medicine.sales_history\r\n        .slice(-30) // Last 30 transactions\r\n        .map(s => s.price)\r\n      \r\n      const avgRecentPrice = recentPrices.reduce((sum, p) => sum + p, 0) / recentPrices.length\r\n      const priceVolatility = calculateVolatility(recentPrices)\r\n      \r\n      // Predict price surge based on volatility and trend\r\n      const priceTrend = calculateTrend(recentPrices)\r\n      const surgeProbability = Math.min(95, Math.max(5, \r\n        (priceVolatility * 100) + (priceTrend > 0 ? 30 : 0)\r\n      ))\r\n      \r\n      const predictedPriceIncrease = surgeProbability > 50 ? \r\n        (surgeProbability / 100) * 0.3 * medicine.current_price : 0\r\n      \r\n      const predictedPrice = medicine.current_price + predictedPriceIncrease\r\n      const priceChangePercent = ((predictedPrice - medicine.current_price) / medicine.current_price) * 100\r\n\r\n      // Calculate recommended stock quantity\r\n      const avgMonthlySales = medicine.sales_history\r\n        .slice(-30)\r\n        .reduce((sum, s) => sum + s.quantity, 0)\r\n      \r\n      const currentStock = inventoryData?.find(inv => inv.medicine_id === medicine.id)?.quantity || 0\r\n      const recommendedStock = surgeProbability > 60 ? \r\n        Math.max(0, (avgMonthlySales * 2) - currentStock) : 0\r\n\r\n      // Generate historical data for chart\r\n      const historicalData = generateHistoricalData(medicine.sales_history)\r\n\r\n      // Determine contributing factors\r\n      const factors = []\r\n      if (priceVolatility > 0.1) factors.push('High price volatility detected')\r\n      if (priceTrend > 0.05) factors.push('Upward price trend observed')\r\n      if (avgMonthlySales > 100) factors.push('High demand volume')\r\n      if (currentStock < avgMonthlySales) factors.push('Low current stock levels')\r\n      factors.push('Seasonal demand patterns')\r\n      factors.push('Market supply constraints')\r\n\r\n      return {\r\n        id: medicine.id,\r\n        medicine_name: medicine.name,\r\n        current_price: medicine.current_price,\r\n        predicted_price: Math.round(predictedPrice * 100) / 100,\r\n        price_change_percent: Math.round(priceChangePercent * 100) / 100,\r\n        surge_probability: Math.round(surgeProbability),\r\n        recommended_stock_quantity: recommendedStock,\r\n        current_stock: currentStock,\r\n        forecast_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days from now\r\n        historical_data: historicalData,\r\n        factors: factors.slice(0, 4) // Top 4 factors\r\n      }\r\n    })\r\n\r\n    // Sort by surge probability (highest first)\r\n    forecasts.sort((a, b) => b.surge_probability - a.surge_probability)\r\n\r\n    return NextResponse.json({ \r\n      success: true, \r\n      forecasts: forecasts.slice(0, 20) // Top 20 medicines\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('Error generating price forecasts:', error)\r\n    return NextResponse.json(\r\n      { success: false, error: 'Failed to generate price forecasts' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\nfunction calculateVolatility(prices: number[]): number {\r\n  if (prices.length < 2) return 0\r\n  \r\n  const mean = prices.reduce((sum, p) => sum + p, 0) / prices.length\r\n  const variance = prices.reduce((sum, p) => sum + Math.pow(p - mean, 2), 0) / prices.length\r\n  return Math.sqrt(variance) / mean // Coefficient of variation\r\n}\r\n\r\nfunction calculateTrend(prices: number[]): number {\r\n  if (prices.length < 2) return 0\r\n  \r\n  const n = prices.length\r\n  const sumX = (n * (n - 1)) / 2\r\n  const sumY = prices.reduce((sum, p) => sum + p, 0)\r\n  const sumXY = prices.reduce((sum, p, i) => sum + (i * p), 0)\r\n  const sumX2 = (n * (n - 1) * (2 * n - 1)) / 6\r\n  \r\n  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX)\r\n  return slope / (sumY / n) // Normalized slope\r\n}\r\n\r\nfunction generateHistoricalData(salesHistory: any[]): any[] {\r\n  const monthlyData = new Map()\r\n  \r\n  salesHistory.forEach(sale => {\r\n    const month = sale.date.substring(0, 7) // YYYY-MM\r\n    if (!monthlyData.has(month)) {\r\n      monthlyData.set(month, { price: [], volume: 0 })\r\n    }\r\n    monthlyData.get(month).price.push(sale.price)\r\n    monthlyData.get(month).volume += sale.quantity\r\n  })\r\n  \r\n  return Array.from(monthlyData.entries())\r\n    .map(([month, data]) => ({\r\n      date: month + '-01',\r\n      price: data.price.reduce((sum, p) => sum + p, 0) / data.price.length,\r\n      sales_volume: data.volume\r\n    }))\r\n    .sort((a, b) => a.date.localeCompare(b.date))\r\n    .slice(-6) // Last 6 months\r\n}"],"names":[],"mappings":"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"}}]
}