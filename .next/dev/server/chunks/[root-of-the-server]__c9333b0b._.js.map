{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Mounith%20Varma%20Akkala/OneDrive/Desktop/New%20folder%20%282%29/v0-smart-pharmacy-ui/app/api/sales/stats/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { createClient } from '@supabase/supabase-js'\r\n\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n)\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url)\r\n    const period = searchParams.get('period') || 'today' // today, week, month, year\r\n\r\n    let dateFilter = ''\r\n    const today = new Date().toISOString().split('T')[0]\r\n\r\n    switch (period) {\r\n      case 'today':\r\n        dateFilter = `sale_date.gte.${today}T00:00:00,sale_date.lte.${today}T23:59:59`\r\n        break\r\n      case 'week':\r\n        const weekAgo = new Date()\r\n        weekAgo.setDate(weekAgo.getDate() - 7)\r\n        dateFilter = `sale_date.gte.${weekAgo.toISOString()}`\r\n        break\r\n      case 'month':\r\n        const monthAgo = new Date()\r\n        monthAgo.setDate(monthAgo.getDate() - 30)\r\n        dateFilter = `sale_date.gte.${monthAgo.toISOString()}`\r\n        break\r\n      case 'year':\r\n        const yearAgo = new Date()\r\n        yearAgo.setFullYear(yearAgo.getFullYear() - 1)\r\n        dateFilter = `sale_date.gte.${yearAgo.toISOString()}`\r\n        break\r\n    }\r\n\r\n    // Get basic sales stats\r\n    let salesQuery = supabase\r\n      .from('sales')\r\n      .select('quantity, total_price, customer_name, sale_date')\r\n\r\n    if (dateFilter) {\r\n      const [field, operator, value] = dateFilter.split('.')\r\n      if (operator === 'gte') {\r\n        salesQuery = salesQuery.gte(field, value)\r\n      } else if (operator === 'lte') {\r\n        salesQuery = salesQuery.lte(field, value)\r\n      }\r\n    }\r\n\r\n    const { data: salesData, error: salesError } = await salesQuery\r\n\r\n    if (salesError) {\r\n      console.error('Sales query error:', salesError)\r\n      throw salesError\r\n    }\r\n\r\n    // Calculate stats\r\n    const totalTransactions = salesData?.length || 0\r\n    const totalUnits = salesData?.reduce((sum, sale) => sum + (sale.quantity || 0), 0) || 0\r\n    const totalRevenue = salesData?.reduce((sum, sale) => sum + (sale.total_price || 0), 0) || 0\r\n    const averageSale = totalTransactions > 0 ? totalRevenue / totalTransactions : 0\r\n    const uniqueCustomers = new Set(salesData?.map(sale => sale.customer_name).filter(Boolean)).size\r\n\r\n    // Get top medicines (need to join with medicines table or use medicine names from sales)\r\n    const { data: topMedicinesData, error: topMedicinesError } = await supabase\r\n      .from('sales')\r\n      .select(`\r\n        medicine_id,\r\n        quantity,\r\n        total_price,\r\n        medicines (name, category)\r\n      `)\r\n      .order('quantity', { ascending: false })\r\n      .limit(10)\r\n\r\n    if (topMedicinesError) {\r\n      console.error('Top medicines query error:', topMedicinesError)\r\n    }\r\n\r\n    // Group top medicines by medicine_id\r\n    const medicineMap = new Map()\r\n    topMedicinesData?.forEach(sale => {\r\n      const medicineId = sale.medicine_id\r\n      const medicines = sale.medicines as any // Type assertion for the relation\r\n      const medicineName = medicines?.name || 'Unknown Medicine'\r\n      const category = medicines?.category || 'General'\r\n      \r\n      if (medicineMap.has(medicineId)) {\r\n        const existing = medicineMap.get(medicineId)\r\n        existing.total_sold += sale.quantity || 0\r\n        existing.revenue += sale.total_price || 0\r\n      } else {\r\n        medicineMap.set(medicineId, {\r\n          medicine_name: medicineName,\r\n          category: category,\r\n          total_sold: sale.quantity || 0,\r\n          revenue: sale.total_price || 0\r\n        })\r\n      }\r\n    })\r\n\r\n    const topMedicines = Array.from(medicineMap.values())\r\n      .sort((a, b) => b.total_sold - a.total_sold)\r\n      .slice(0, 10)\r\n\r\n    // Get daily sales trend (last 7 days)\r\n    const sevenDaysAgo = new Date()\r\n    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)\r\n\r\n    const { data: trendData, error: trendError } = await supabase\r\n      .from('sales')\r\n      .select('sale_date, quantity, total_price')\r\n      .gte('sale_date', sevenDaysAgo.toISOString())\r\n      .order('sale_date', { ascending: true })\r\n\r\n    if (trendError) {\r\n      console.error('Trend query error:', trendError)\r\n    }\r\n\r\n    // Group trend data by day\r\n    const trendMap = new Map()\r\n    trendData?.forEach(sale => {\r\n      const day = sale.sale_date.split('T')[0] // Get just the date part\r\n      \r\n      if (trendMap.has(day)) {\r\n        const existing = trendMap.get(day)\r\n        existing.transactions += 1\r\n        existing.revenue += sale.total_price || 0\r\n        existing.units_sold += sale.quantity || 0\r\n      } else {\r\n        trendMap.set(day, {\r\n          sale_day: day,\r\n          transactions: 1,\r\n          revenue: sale.total_price || 0,\r\n          units_sold: sale.quantity || 0\r\n        })\r\n      }\r\n    })\r\n\r\n    const salesTrend = Array.from(trendMap.values()).sort((a, b) => \r\n      new Date(a.sale_day).getTime() - new Date(b.sale_day).getTime()\r\n    )\r\n\r\n    // Mock payment methods data (since we don't have this field in current schema)\r\n    const paymentMethods = [\r\n      { payment_method: 'Cash', transaction_count: Math.floor(totalTransactions * 0.6), revenue: totalRevenue * 0.6 },\r\n      { payment_method: 'Card', transaction_count: Math.floor(totalTransactions * 0.3), revenue: totalRevenue * 0.3 },\r\n      { payment_method: 'UPI', transaction_count: Math.floor(totalTransactions * 0.1), revenue: totalRevenue * 0.1 }\r\n    ]\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: {\r\n        summary: {\r\n          total_transactions: totalTransactions,\r\n          total_units_sold: totalUnits,\r\n          total_revenue: totalRevenue,\r\n          average_sale_value: averageSale,\r\n          unique_customers: uniqueCustomers\r\n        },\r\n        paymentMethods: paymentMethods,\r\n        topMedicines: topMedicines,\r\n        salesTrend: salesTrend,\r\n        period: period\r\n      }\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('Sales Stats API Error:', error)\r\n    return NextResponse.json(\r\n      { success: false, error: 'Failed to fetch sales statistics', details: error instanceof Error ? error.message : 'Unknown error' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}