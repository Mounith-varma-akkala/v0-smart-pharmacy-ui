{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Mounith%20Varma%20Akkala/OneDrive/Desktop/New%20folder%20%282%29/v0-smart-pharmacy-ui/app/api/inventory/expiry/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { createClient } from '@supabase/supabase-js'\r\n\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n)\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url)\r\n    const alertDays = parseInt(searchParams.get('alert_days') || '30')\r\n\r\n    const { data: batches, error } = await supabase\r\n      .from('inventory_batches')\r\n      .select(`\r\n        *,\r\n        medicines (name),\r\n        suppliers (name)\r\n      `)\r\n      .order('expiry_date', { ascending: true }) // FEFO ordering\r\n\r\n    if (error) throw error\r\n\r\n    const currentDate = new Date()\r\n    \r\n    const processedBatches = batches?.map(batch => {\r\n      const expiryDate = new Date(batch.expiry_date)\r\n      const daysToExpiry = Math.ceil((expiryDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24))\r\n      \r\n      let expiryStatus: 'expired' | 'critical' | 'warning' | 'safe'\r\n      if (daysToExpiry < 0) {\r\n        expiryStatus = 'expired'\r\n      } else if (daysToExpiry <= 7) {\r\n        expiryStatus = 'critical'\r\n      } else if (daysToExpiry <= alertDays) {\r\n        expiryStatus = 'warning'\r\n      } else {\r\n        expiryStatus = 'safe'\r\n      }\r\n\r\n      return {\r\n        id: batch.id,\r\n        medicine_name: batch.medicines?.name || 'Unknown Medicine',\r\n        batch_number: batch.batch_number,\r\n        expiry_date: batch.expiry_date,\r\n        quantity: batch.quantity,\r\n        cost_price: batch.cost_price,\r\n        supplier_name: batch.suppliers?.name || 'Unknown Supplier',\r\n        days_to_expiry: daysToExpiry,\r\n        expiry_status: expiryStatus,\r\n        suggested_for_sale: expiryStatus === 'warning' || expiryStatus === 'critical'\r\n      }\r\n    }) || []\r\n\r\n    return NextResponse.json({ \r\n      success: true, \r\n      batches: processedBatches \r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('Error fetching inventory batches:', error)\r\n    return NextResponse.json(\r\n      { success: false, error: 'Failed to fetch inventory batches' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n// FEFO Logic - Get next batch to sell for a medicine\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { medicine_id, quantity_needed } = await request.json()\r\n\r\n    const { data: batches, error } = await supabase\r\n      .from('inventory_batches')\r\n      .select('*')\r\n      .eq('medicine_id', medicine_id)\r\n      .gt('quantity', 0)\r\n      .order('expiry_date', { ascending: true }) // FEFO: earliest expiry first\r\n\r\n    if (error) throw error\r\n\r\n    let remainingQuantity = quantity_needed\r\n    const selectedBatches = []\r\n\r\n    for (const batch of batches || []) {\r\n      if (remainingQuantity <= 0) break\r\n\r\n      const quantityFromBatch = Math.min(batch.quantity, remainingQuantity)\r\n      selectedBatches.push({\r\n        batch_id: batch.id,\r\n        batch_number: batch.batch_number,\r\n        quantity: quantityFromBatch,\r\n        expiry_date: batch.expiry_date\r\n      })\r\n\r\n      remainingQuantity -= quantityFromBatch\r\n    }\r\n\r\n    return NextResponse.json({ \r\n      success: true, \r\n      selected_batches: selectedBatches,\r\n      remaining_quantity: remainingQuantity\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('Error applying FEFO logic:', error)\r\n    return NextResponse.json(\r\n      { success: false, error: 'Failed to apply FEFO logic' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,MAAM,WAAW,IAAA,gMAAY;AAKtB,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,YAAY,SAAS,aAAa,GAAG,CAAC,iBAAiB;QAE7D,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SACpC,IAAI,CAAC,qBACL,MAAM,CAAC,CAAC;;;;MAIT,CAAC,EACA,KAAK,CAAC,eAAe;YAAE,WAAW;QAAK,GAAG,gBAAgB;;QAE7D,IAAI,OAAO,MAAM;QAEjB,MAAM,cAAc,IAAI;QAExB,MAAM,mBAAmB,SAAS,IAAI,CAAA;YACpC,MAAM,aAAa,IAAI,KAAK,MAAM,WAAW;YAC7C,MAAM,eAAe,KAAK,IAAI,CAAC,CAAC,WAAW,OAAO,KAAK,YAAY,OAAO,EAAE,IAAI,CAAC,OAAO,KAAK,KAAK,EAAE;YAEpG,IAAI;YACJ,IAAI,eAAe,GAAG;gBACpB,eAAe;YACjB,OAAO,IAAI,gBAAgB,GAAG;gBAC5B,eAAe;YACjB,OAAO,IAAI,gBAAgB,WAAW;gBACpC,eAAe;YACjB,OAAO;gBACL,eAAe;YACjB;YAEA,OAAO;gBACL,IAAI,MAAM,EAAE;gBACZ,eAAe,MAAM,SAAS,EAAE,QAAQ;gBACxC,cAAc,MAAM,YAAY;gBAChC,aAAa,MAAM,WAAW;gBAC9B,UAAU,MAAM,QAAQ;gBACxB,YAAY,MAAM,UAAU;gBAC5B,eAAe,MAAM,SAAS,EAAE,QAAQ;gBACxC,gBAAgB;gBAChB,eAAe;gBACf,oBAAoB,iBAAiB,aAAa,iBAAiB;YACrE;QACF,MAAM,EAAE;QAER,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;QACX;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAAoC,GAC7D;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,EAAE,WAAW,EAAE,eAAe,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE3D,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SACpC,IAAI,CAAC,qBACL,MAAM,CAAC,KACP,EAAE,CAAC,eAAe,aAClB,EAAE,CAAC,YAAY,GACf,KAAK,CAAC,eAAe;YAAE,WAAW;QAAK,GAAG,8BAA8B;;QAE3E,IAAI,OAAO,MAAM;QAEjB,IAAI,oBAAoB;QACxB,MAAM,kBAAkB,EAAE;QAE1B,KAAK,MAAM,SAAS,WAAW,EAAE,CAAE;YACjC,IAAI,qBAAqB,GAAG;YAE5B,MAAM,oBAAoB,KAAK,GAAG,CAAC,MAAM,QAAQ,EAAE;YACnD,gBAAgB,IAAI,CAAC;gBACnB,UAAU,MAAM,EAAE;gBAClB,cAAc,MAAM,YAAY;gBAChC,UAAU;gBACV,aAAa,MAAM,WAAW;YAChC;YAEA,qBAAqB;QACvB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,kBAAkB;YAClB,oBAAoB;QACtB;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAA6B,GACtD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}